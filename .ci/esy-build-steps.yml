parameters:
  platform: "macOS"
  vmImage: "macOS-latest"
  
# Cross-platform set of build steps for building esy projects

steps:
  
  - template: utils/use-node.yml
  - template: utils/use-esy.yml
  - template: utils/use-cache-esy-sources.yml
  - template: utils/use-cache-esy-install-tree.yml
    parameters:
      platform: ${{ parameters.platform }}
      vmImage: ${{ parameters.vmImage }}
  - script: 'npm install'
    displayName: 'npm install'
  - ${{ if eq(parameters.platform,  'Ubuntu_16_04') }}:
    - script: npm i -g esy@0.6.4
      displayName: 'Install esy@0.6.4 for Ubuntu 16.04 (bootstrapping)'
  - ${{ if eq(parameters.platform,  'macOS_10_12') }}:
    - script: node scripts/create-macos-12-esy-manifest.js
      displayName: 'Build with MACOSX_DEPLOYMENT_TARGET = 10.12'
  - script: "esy install"
    displayName: "esy install"
  # This is unnecessary now that store is cached via Cache@2 azure task. Runing this could help with testing the flow e2e
  # - template: utils/restore-build-cache.yml
  - script: "esy build"
    displayName: "esy build"
  - template: utils/publish-build-cache.yml
  - script: 'esy dune build @fmt'
    displayName: 'Check code formatting'
    condition: ne(variables['AGENT.OS'], 'Windows_NT')
  # - script: 'esy b dune runtest test'
  #   displayName: 'esy b dune runtest test'
  # - script: 'node ./node_modules/jest-cli/bin/jest.js'
  #   displayName: 'esy test:e2e'
  # - script: 'npm install'
  #   workingDirectory: './test-e2e-re/lib/verdaccio/'
  #   continueOnError: true
  #   displayName: 'esy test:e2e-re: npm install'
  # - script: 'esy test:e2e-re'
  #   continueOnError: true
  #   displayName: 'esy test:e2e-re'
  # - script: 'node ./test-e2e-slow/run-slow-tests.js'
  #   displayName: 'esy test:e2e-slow'
  #   continueOnError: true
  - ${{ if eq(parameters.platform,  'Ubuntu_16_04') }}:
    - script: "esy x esy release"
      displayName: "esy release"
  - ${{ if ne(parameters.platform,  'Ubuntu_16_04') }}:
    - script: "esy x esy release --no-env"
      displayName: "esy release --no-env"
