"use strict";(self.webpackChunksite_v_3=self.webpackChunksite_v_3||[]).push([[5555],{9254:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>c,metadata:()=>r,toc:()=>t});var i=s(4848),d=s(8453);const c={id:"configuration",title:"Project Configuration"},o=void 0,r={id:"configuration",title:"Project Configuration",description:"package.json",source:"@site/../docs/configuration.md",sourceDirName:".",slug:"/configuration",permalink:"/docs/configuration",draft:!1,unlisted:!1,editUrl:"https://github.com/esy/esy/tree/master/docs/../docs/configuration.md",tags:[],version:"current",lastUpdatedBy:"prometheansacrifice",lastUpdatedAt:1729151217,formattedLastUpdatedAt:"Oct 17, 2024",frontMatter:{id:"configuration",title:"Project Configuration"},sidebar:"docs",previous:{title:"Concepts",permalink:"/docs/concepts"},next:{title:"Environment",permalink:"/docs/environment"}},l={},t=[{value:"package.json",id:"packagejson",level:2},{value:"Specify Build &amp; Install Commands",id:"specify-build--install-commands",level:2},{value:"<code>esy.build</code>",id:"esybuild",level:3},{value:"<code>esy.buildDev</code>",id:"esybuilddev",level:3},{value:"<code>esy.install</code> (optional)",id:"esyinstall-optional",level:3},{value:"Enforcing Out Of Source Builds",id:"enforcing-out-of-source-builds",level:2},{value:"<code>esy.buildsInSource</code>",id:"esybuildsinsource",level:3},{value:"Exported Environment",id:"exported-environment",level:2},{value:"<code>esy.exportedEnv</code>",id:"esyexportedenv",level:3},{value:"Build Environment",id:"build-environment",level:2},{value:"<code>esy.buildEnv</code>",id:"esybuildenv",level:3},{value:"Example: dune (jbuilder)",id:"example-dune-jbuilder",level:2},{value:"Specify dependencies",id:"specify-dependencies",level:2},{value:"<code>dependencies</code>",id:"dependencies",level:3},{value:"<code>devDependencies</code>",id:"devdependencies",level:3},{value:"<code>resolutions</code>",id:"resolutions",level:3},{value:"Project Specific Commands",id:"project-specific-commands",level:2},{value:"<code>scripts</code>",id:"scripts",level:3}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",em:"em",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,d.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"packagejson",children:"package.json"}),"\n",(0,i.jsxs)(n.p,{children:["esy knows how to build your package and its dependencies by looking at the\n",(0,i.jsx)(n.code,{children:"package.json"})," file at the root of the project."]}),"\n",(0,i.jsxs)(n.p,{children:["Because esy needs more information about the project, it extends ",(0,i.jsx)(n.code,{children:"package.json"}),"\nwith the following fields:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#esybuild",children:(0,i.jsx)(n.code,{children:"esy.build"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#esybuilddev",children:(0,i.jsx)(n.code,{children:"esy.buildDev"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#esyinstall",children:(0,i.jsx)(n.code,{children:"esy.install"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#esybuildsinsource",children:(0,i.jsx)(n.code,{children:"esy.buildsInSource"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#esyexportedenv",children:(0,i.jsx)(n.code,{children:"esy.exportedEnv"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#esybuildenv",children:(0,i.jsx)(n.code,{children:"esy.buildEnv"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#resolutions",children:(0,i.jsx)(n.code,{children:"resolutions"})})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#scripts",children:(0,i.jsx)(n.code,{children:"scripts"})})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"specify-build--install-commands",children:"Specify Build & Install Commands"}),"\n",(0,i.jsxs)(n.p,{children:["The crucial pieces of configuration are ",(0,i.jsx)(n.code,{children:"esy.build"})," and ",(0,i.jsx)(n.code,{children:"esy.install"})," keys, they\nspecify how to build and install built artifacts."]}),"\n",(0,i.jsx)(n.h3,{id:"esybuild",children:(0,i.jsx)(n.code,{children:"esy.build"})}),"\n",(0,i.jsx)(n.p,{children:"Describe how your package's default targets should be built when package is\nbeing used as a dependency."}),"\n",(0,i.jsxs)(n.p,{children:["For example, for a ",(0,i.jsx)(n.a,{href:"https://dune.readthedocs.io/",children:"dune"})," based package you'd want to call ",(0,i.jsx)(n.code,{children:"dune build"}),"\ncommand."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "esy": {\n    "build": [\n      "dune build -p #{self.name}",\n    ]\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"/docs/environment#variable-substitution-syntax",children:"esy variable substitution syntax"})," can be used to\ndeclare build commands."]}),"\n",(0,i.jsx)(n.h3,{id:"esybuilddev",children:(0,i.jsx)(n.code,{children:"esy.buildDev"})}),"\n",(0,i.jsx)(n.p,{children:"Describe how your package's default targets should be built when package is\nbeing developed. This is only used for the root package of an esy project."}),"\n",(0,i.jsxs)(n.p,{children:["The main difference with ",(0,i.jsx)(n.code,{children:"esy.build"})," is that commands declared in ",(0,i.jsx)(n.code,{children:"esy.buildDev"}),"\nhave access to ",(0,i.jsx)(n.code,{children:'"devDependencies"'}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["For example, for a ",(0,i.jsx)(n.a,{href:"https://dune.readthedocs.io/",children:"dune"})," based package you'd want\nto call ",(0,i.jsx)(n.code,{children:"dune build"})," command."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "esy": {\n    "buildDev": [\n      "refmterr dune build --root . --only-packages #{self.name}",\n    ]\n  },\n  "devDependencies": {\n    "refmterr": "*",\n    ...\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Note that we use ",(0,i.jsx)(n.code,{children:"refmterr"})," command which is declared in ",(0,i.jsx)(n.code,{children:'"devDependencies"'}),"\nsection."]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"/docs/environment#variable-substitution-syntax",children:"esy variable substitution syntax"}),"\ncan be used to declare build commands."]}),"\n",(0,i.jsxs)(n.p,{children:["If no ",(0,i.jsx)(n.code,{children:"esy.buildDev"})," is defined then ",(0,i.jsx)(n.code,{children:"esy.build"})," is used instead."]}),"\n",(0,i.jsxs)(n.h3,{id:"esyinstall-optional",children:[(0,i.jsx)(n.code,{children:"esy.install"})," (optional)"]}),"\n",(0,i.jsxs)(n.p,{children:["By default ",(0,i.jsx)(n.code,{children:"esy"})," will look for a single ",(0,i.jsx)(n.code,{children:"*.install"})," file in the project root and\nwill transfer all files mentioned there into ",(0,i.jsx)(n.code,{children:"#{self.install}"})," directory."]}),"\n",(0,i.jsxs)(n.p,{children:["This follows the convention of opam and plays well with ",(0,i.jsx)(n.code,{children:"dune"})," (which produces\n",(0,i.jsx)(n.code,{children:"*.install"})," files by default)."]}),"\n",(0,i.jsx)(n.p,{children:"But some projects can have special requirements:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Some have multiple ",(0,i.jsx)(n.code,{children:"*.install"})," files and want to install artifacts only from\nsome of them."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Some might require custom commands to be executed (for example ",(0,i.jsx)(n.code,{children:"make install"}),")."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["There's ",(0,i.jsx)(n.code,{children:"esy.install"})," config key which allows to specify a set of commands which\nshould move built artifacts to ",(0,i.jsx)(n.code,{children:"#{self.install}"})," location."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "esy": {\n    "build": [...],\n    "install": [\n      "dune install --prefix=#{self.install}"\n    ]\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.a,{href:"/docs/environment#variable-substitution-syntax",children:"esy variable substitution syntax"})," can be used to\ndeclare install commands."]}),"\n",(0,i.jsx)(n.h2,{id:"enforcing-out-of-source-builds",children:"Enforcing Out Of Source Builds"}),"\n",(0,i.jsx)(n.p,{children:'esy requires packages to be built "out of source".'}),"\n",(0,i.jsx)(n.p,{children:"It allows esy to separate source code from built artifacts and thus reuse the\nsame source code location between several sandboxes."}),"\n",(0,i.jsx)(n.h3,{id:"esybuildsinsource",children:(0,i.jsx)(n.code,{children:"esy.buildsInSource"})}),"\n",(0,i.jsxs)(n.p,{children:['Because not every project\'s build system is designed in a way which allows "out\nof source" builds esy has special settings ',(0,i.jsx)(n.code,{children:"esy.buildsInSource"})," which provide\na useful workaround."]}),"\n",(0,i.jsxs)(n.p,{children:["There are three modes which are controlled by ",(0,i.jsx)(n.code,{children:"esy.buildsInSource"})," config key:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "esy": {\n    "build": [...],\n    "install": [...],\n    "buildsInSource": "_build" | false | true,\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Each mode changes how esy executes ",(0,i.jsx)(n.a,{href:"#esybuild",children:"build commands"}),". This is how\nthose modes work:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:'"_build"'})}),"\n",(0,i.jsxs)(n.p,{children:["Build commands can place artifacts inside the ",(0,i.jsx)(n.code,{children:"_build"})," directory of the\nproject's root (",(0,i.jsx)(n.code,{children:"$cur__root/_build"})," in terms of esy ",(0,i.jsx)(n.a,{href:"environment.md#build-environment",children:"build\nenvironment"}),")."]}),"\n",(0,i.jsxs)(n.p,{children:["This is what ",(0,i.jsx)(n.a,{href:"https://dune.readthedocs.io/",children:"dune"})," or ",(0,i.jsx)(n.a,{href:"https://github.com/ocaml/ocamlbuild/blob/master/manual/manual.adoc",children:"ocamlbuild"})," (in its default configuration)\nusers should be using as this matches those build systems' conventions."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"false"})," (default if key is omitted)"]}),"\n",(0,i.jsxs)(n.p,{children:["Build commands should use ",(0,i.jsx)(n.code,{children:"$cur__target_dir"})," as the build directory."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"true"})}),"\n",(0,i.jsxs)(n.p,{children:["Projects are allowed to place build artifacts anywhere in their source tree, but not outside of their source tree. Otherwise, esy will defensively copy project's root into ",(0,i.jsx)(n.code,{children:"$cur__target_dir"})," and run build commands from there."]}),"\n",(0,i.jsx)(n.p,{children:"This is the mode which should be used as the last resort as it degrades\nperformance of the builds greatly by placing correctness as a priority."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"exported-environment",children:"Exported Environment"}),"\n",(0,i.jsx)(n.p,{children:"Packages can configure how they contribute to the environment of the packages\nwhich depend on them."}),"\n",(0,i.jsx)(n.h3,{id:"esyexportedenv",children:(0,i.jsx)(n.code,{children:"esy.exportedEnv"})}),"\n",(0,i.jsxs)(n.p,{children:["To add a new environment variable to the esy ",(0,i.jsx)(n.a,{href:"#build-environment",children:"build\nenvironment"})," packages could specify ",(0,i.jsx)(n.code,{children:"esy.exportedEnv"})," config\nkey:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "name": "mylib",\n  "esy": {\n    ...,\n    "exportedEnv": {\n      "CAML_LD_LIBRARY_PATH": {\n        "val": "#{mylib.lib : $CAML_LD_LIBRARY_PATH}",\n        "scope": "global"\n      }\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["In the example above, the configuration ",(0,i.jsx)(n.em,{children:"exports"})," (in this specific case it\n",(0,i.jsx)(n.em,{children:"re-exports"})," it) an environment variable called ",(0,i.jsx)(n.code,{children:"$CAML_LD_LIBRARY_PATH"})," by\nappending ",(0,i.jsx)(n.code,{children:"$mylib__lib"})," to its previous value."]}),"\n",(0,i.jsxs)(n.p,{children:["Note the usage of ",(0,i.jsx)(n.a,{href:"#variable-substitution-syntax",children:"esy variable substitution\nsyntax"})," to define the value of the\n",(0,i.jsx)(n.code,{children:"$CAML_LD_LIBRARY_PATH"})," variable."]}),"\n",(0,i.jsx)(n.h2,{id:"build-environment",children:"Build Environment"}),"\n",(0,i.jsx)(n.p,{children:"Packages can configure their own build environment."}),"\n",(0,i.jsx)(n.p,{children:"Note that build environment doesn't propagate to dependencies, only current\npackage's build process can access it."}),"\n",(0,i.jsx)(n.h3,{id:"esybuildenv",children:(0,i.jsx)(n.code,{children:"esy.buildEnv"})}),"\n",(0,i.jsxs)(n.p,{children:["To add a new environment variable to the build environment of the current\npackage there's ",(0,i.jsx)(n.code,{children:"esy.buildEnv"})," config key:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'{\n  "name": "mylib",\n  "esy": {\n    ...,\n    "buildEnv": {\n      "DUNE_BUILD_DIR": "#{self.target_dir}"\n    }\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Note the usage of ",(0,i.jsx)(n.a,{href:"#variable-substitution-syntax",children:"esy variable substitution\nsyntax"})," to define the value of the\n",(0,i.jsx)(n.code,{children:"$DUNE_BUILD_DIR"})," variable."]}),"\n",(0,i.jsx)(n.h2,{id:"example-dune-jbuilder",children:"Example: dune (jbuilder)"}),"\n",(0,i.jsxs)(n.p,{children:["This is how it looks for a ",(0,i.jsx)(n.a,{href:"https://dune.readthedocs.io/",children:"dune"})," (formely\njbuilder) based project:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "name": "my-dune-project",\n  "version": "1.0.0",\n\n  "esy": {\n    "build": ["dune build"],\n    "buildEnv": {"DUNE_BUILD_DIR": "#{self.target_dir}"}\n  },\n\n  "dependencies": {\n    "@opam/dune": "*",\n    "ocaml": "*"\n  }\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"specify-dependencies",children:"Specify dependencies"}),"\n",(0,i.jsx)(n.h3,{id:"dependencies",children:(0,i.jsx)(n.code,{children:"dependencies"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["This works similar to npm or yarn standard ",(0,i.jsx)(n.code,{children:"dependencies"})," configuration."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["To define a set of dependencies of the package specify them in ",(0,i.jsx)(n.code,{children:"dependencies"}),"\nkey inside ",(0,i.jsx)(n.code,{children:"package.json"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'"dependencies": {\n  "refmterr": "^3.1.7",\n  "@esy-ocaml/reason": "^3.0.0"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["We refer to the ",(0,i.jsxs)(n.a,{href:"https://docs.npmjs.com/files/package.json#dependencies",children:["npm documentation on ",(0,i.jsx)(n.code,{children:"dependencies"})]})," for the\nsyntax of possible package constraints."]}),"\n",(0,i.jsxs)(n.p,{children:["As esy allows to work with packages hosted on opam repository it extends npm's\nstandard mechanism with a special handling of ",(0,i.jsx)(n.code,{children:"@opam/*"})," scope:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Any scoped package ",(0,i.jsx)(n.code,{children:"@opam/PKG"})," refers to an opam packsage ",(0,i.jsx)(n.code,{children:"PKG"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Any constraint for a scoped package ",(0,i.jsx)(n.code,{children:"@opam/PKG"})," is a constraint against opam\nversions."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"devdependencies",children:(0,i.jsx)(n.code,{children:"devDependencies"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["This works similar to npm or yarn standard ",(0,i.jsx)(n.code,{children:"devDependencies"})," configuration."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"devDependencies"})," works similar to ",(0,i.jsx)(n.code,{children:"dependencies"})," but they are only handled for\nthe root package and override the constraints found in ",(0,i.jsx)(n.code,{children:"dependencies"})," key."]}),"\n",(0,i.jsx)(n.h3,{id:"resolutions",children:(0,i.jsx)(n.code,{children:"resolutions"})}),"\n",(0,i.jsxs)(n.p,{children:["It's sometimes necessary to override the package version determined by the\nsolver. In such a case, use ",(0,i.jsx)(n.code,{children:"resolutions"})," field in the ",(0,i.jsx)(n.code,{children:"package.json"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'"resolutions": {\n  "@opam/menhir": "20171013"\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"Resolutions are only valid in the current project and are not exported."}),"\n",(0,i.jsxs)(n.p,{children:["This feature works similar to yarn's ",(0,i.jsx)(n.a,{href:"https://yarnpkg.com/lang/en/docs/selective-version-resolutions/",children:"Selective dependency resolutions"}),"\nbut nested patterns (which contain ",(0,i.jsx)(n.code,{children:"**"})," or ",(0,i.jsx)(n.code,{children:"*"})," are not supported)."]}),"\n",(0,i.jsx)(n.h2,{id:"project-specific-commands",children:"Project Specific Commands"}),"\n",(0,i.jsx)(n.h3,{id:"scripts",children:(0,i.jsx)(n.code,{children:"scripts"})}),"\n",(0,i.jsxs)(n.p,{children:["Similar to npm and yarn, esy supports custom project specific commands via\n",(0,i.jsx)(n.code,{children:"scripts"})," section inside ",(0,i.jsx)(n.code,{children:"package.json"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'"scripts": {\n  "build-dev": "esy build dune build --dev",\n  "test": "dune runtest",\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"The example above defines two new commands."}),"\n",(0,i.jsxs)(n.p,{children:["The command ",(0,i.jsx)(n.code,{children:"esy build-dev"})," is configured to be a shortcut for the following\ninvocation:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"esy build dune build\n"})}),"\n",(0,i.jsxs)(n.p,{children:["While the command ",(0,i.jsx)(n.code,{children:"esy test"})," is defined to be a shortcut for:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"esy dune runtest\n"})}),"\n",(0,i.jsxs)(n.p,{children:["For non-interactive (ie. when used in scripts), to ensure forward compatiblity, we encourage a more verbose\n",(0,i.jsx)(n.code,{children:"esy run-script build-dev"})," and ",(0,i.jsx)(n.code,{children:"esy run-script test"}),". Explicitly specifying\n",(0,i.jsx)(n.code,{children:"run-script"})," prevents clashes with subcommands that we add in future."]}),"\n",(0,i.jsxs)(n.p,{children:["Note that if a command in ",(0,i.jsx)(n.code,{children:"scripts"})," is not prefixed with the ",(0,i.jsx)(n.code,{children:"esy"})," command then it's made to automatically execute inside the ",(0,i.jsx)(n.a,{href:"/docs/environment#Command-Environment",children:"Command Environment"}),"."]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>r});var i=s(6540);const d={},c=i.createContext(d);function o(e){const n=i.useContext(c);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(d):e.components||d:o(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);